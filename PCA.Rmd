---
title: "PCA of crop diversity in time and space"
author: "Josepha Schiller"
date: "2024-09-27"
output: html_document
---


last update: 14.05.2025

Note: the PCA follows the tutorial from https://www.datacamp.com/tutorial/pca-analysis-r 
There is another published version with less information

Load libraries

```{r, warning=FALSE, message=FALSE}
# load libaries
library(tidyverse)
library(corrr)
library(ggcorrplot)
library(FactoMineR)
library(factoextra)
library(gridExtra)
```

Load spatial and temporal crop information.
```{r}
setwd("D:/Josi/PhD/CrossDIV/WP1.2_Method/WP1.2_Method_Data/R Scripts/4_IACS_Betriebe_exploration/output_files")

# spatial crop diversity (without considering farms)
div_sp <- read.table(file = "farm_grid_spatial_mean_20241028.csv", header = T, sep = ",")
div_sp %>% colnames()

# temporal crop diversity (per field over 10 years)
div_rot <- read.table(file = "crop_rot_div_20241025.csv", header = T, sep = ",")
div_rot %>% colnames()

```

remove unnecessary columns
```{r}
div_sp <- div_sp %>% dplyr::select(Index, crop_sp_SDI,crop_sp_SEI, crop_sp_rich)
div_sp %>% head()
div_rot <- div_rot %>% dplyr::select(!crop_field_nr)
div_rot %>% head()
```

combine both files
```{r}
crop_div <- full_join(div_rot, div_sp, by = c("id" = "Index"))
crop_div %>% head()
```


```{r}
load("D:/Josi/PhD/CrossDIV/WP1.2_Method/WP1.2_Method_Data/R Scripts/4_IACS_Betriebe_exploration/output_files/IACS_points_20241024.Rdata")

crop_div[176,]

crop_div %>% filter(crop_rot_rich < 3)

```


```{r}
# check for NA
colSums(is.na(crop_div))
summary(crop_div)
```

### Prepare PCA 

1. Normalize
```{r}
numerical_data <- crop_div[,1:7] #select columns of interest
head(numerical_data)


for (col in colnames(numerical_data )) {
  
  # Boxplot 
  p1 <- ggplot(numerical_data , aes_string(x = col)) +
    geom_boxplot() +
    theme_minimal() +
    ggtitle(paste("Boxplot of", col))
  
  # Histogram
  p2 <- ggplot(numerical_data , aes_string(x = col)) +
    geom_histogram( fill = "blue", color = "black", alpha = 0.7) +
    theme_minimal() +
    ggtitle(paste("Histogram of", col))
  
  # combine
   grid.arrange(p1, p2, nrow = 1, ncol = 2)
  
  # save
#  png(filename = paste0(col, "_plot2.png"), width = 1000, height = 500)
#  grid.draw(combined_plot)  
#  dev.off()  
}
```


```{r}
mysubset <- numerical_data[,2:7] %>% dplyr::select(-ends_with("SEI"))
data_normalized <- scale(numerical_data[,2:7])
head(data_normalized)


data_normalized %>% summary()
```

Plot disitribution of normalized data
```{r, warning = F, echo=F}
for (col in colnames(data_normalized)) {
  
  # Boxplot 
  p1 <- ggplot(data_normalized, aes_string(x = col)) +
    geom_boxplot() +
    theme_minimal() +
    ggtitle(paste("Boxplot of", col))
  
  # Histogram
  p2 <- ggplot(data_normalized, aes_string(x = col)) +
    geom_histogram( fill = "blue", color = "black", alpha = 0.7) +
    theme_minimal() +
    ggtitle(paste("Histogram of", col))
  
  # combine
   grid.arrange(p1, p2, nrow = 1, ncol = 2)
  
  # save
#  png(filename = paste0(col, "_plot2.png"), width = 1000, height = 500)
#  grid.draw(combined_plot)  
#  dev.off()  
}


```

### Apply PCA

```{r}
data.pca <- princomp(data_normalized) # R-mode PCA (feature extraction)
```


```{r}
print(data.pca)
plot(data.pca) # scree plot
biplot(data.pca)
```

Inspect all the information related to the PCA result
```{r}
data.pca$sdev # sdec of principal components
data.pca$loadings # zeigt den einfluss auf ein PC
data.pca$n.obs
data.pca$scale
data.pca$scores %>% head() # this could be used as new variables
data.pca$call
summary(data.pca) # there are 6 components

```

Try a different way to apply PCA
```{r}
data.pca2 <- prcomp(numerical_data, scale = T) # Q-mode PCA 

```

Inspect new results
```{r}
data.pca2$loadings
data.pca2$scale
data.pca2$center
data.pca2$loadings

summary(data.pca2) # there are 6 components
```


```{r}
my_pca <- data.frame(data.pca$x[, 1:2])

print(data.pca)
plot(data.pca)
```


```{r}
data.pca$loadings[, 1:3]
# --> comp1 crop rot rich + sdi are relatively high, and crop sp, too
# --> crop rot eveness is hgihest, but crop sp are all negativ
# --> copm3 hih crop rot rich,
```


```{r}
#fviz_nbclust(my_pca,
#             FUNcluster = kmeans,
#             method = "wss")
```


```{r}
#set.seed(123)
#my_kmeans <- kmeans(my_pca, centers = 4)

#fviz_pca_ind(data.pca, 
#             habillage = my_kmeans$cluster,
#             label = "none",
 #            addEllipses = T)
```


```{r}
# scree plot
fviz_eig(data.pca, addlabels = TRUE) # shows the percentage of variance explained by components 
# --> can be used to determine how many components will be kept
```


```{r}
fviz_pca_ind(data.pca, col.ind="cos2")

```


```{r}
# Graph of the variables
fviz_pca_var(data.pca, col.var = "black")

```


```{r}
fviz_pca_var(data.pca, col.var="contrib")+
  scale_color_gradient2(low="white", mid="blue",
                        high="red", midpoint = 17) +
  theme_minimal()

bi_plot <- fviz_pca_biplot(data.pca, label ="var") + 
 theme_minimal() +
  theme(panel.grid = element_blank(),
        panel.grid.major = element_blank(),  # Remove major grid lines
        panel.grid.minor = element_blank(),
        axis.line = element_line(color = "black"),
        panel.border = element_blank())
```


```{r}
#setwd("D:/Josi/PhD/CrossDIV/WP1.2_Method/WP1.2_Method_Data/R Scripts/4_IACS_Betriebe_exploration/output_files/PCA_results")

#png("PCA_biplots.png", width=420, height=280) # A4 width is ~8.3 inches = 840px at 100dpi, so half is 420px
bi_plot
#dev.off()
# A4 width is 8.27 inches, so half width is 4.135 inches
#pdf("PCA_biplots.pdf", width=4.135, height=2.76)
bi_plot
#dev.off()

# create pearson's correlation plots to test temporal and spatial correlation
```


```{r}
# Calculate correlations
cor_rich <- cor(crop_div$crop_rot_rich, crop_div$crop_sp_rich, method="pearson")
cor_sdi <- cor(crop_div$crop_rot_SDI, crop_div$crop_sp_SDI, method="pearson")
# Create scatter plots
p1 <- ggplot(crop_div, aes(x=crop_rot_rich, y=crop_sp_rich)) +
  geom_point(alpha = 0.5, size = 2) +
  geom_smooth(method = "lm", color = "red", se = F) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(color = "black"),
        panel.border = element_blank()) +
  labs(x = "Over Time", 
       y = "In Space",
       title = "Species Richness") +
  annotate("text", x = Inf, y = -Inf, 
           label = sprintf("r = %.2f", cor_rich),
           hjust = 1.1, vjust = -0.5)

p2 <- ggplot(crop_div, aes(x = crop_rot_SDI, y = crop_sp_SDI)) +
  geom_point(alpha = 0.5, size = 2) +
  geom_smooth(method = "lm", color = "red", se = F) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(color = "black"),
        panel.border = element_blank()) +
  labs(x = "Over Time", 
       y = "", 
       title = "Shannon's Diversity") +
  annotate("text", x = Inf, y = -Inf,
           label = sprintf("r = %.2f", cor_sdi),
           hjust = 1.1, vjust = -0.5)

# Create layout matrix for arrangement
lay <- rbind(c(1,1),
            c(2,3))

# Adjust text sizes for consistency - using standard sizes for scientific publications
p1 <- p1 + theme(text = element_text(size=6),
                 plot.title = element_text(size=9),
                 axis.title = element_text(size=8),
                 axis.text = element_text(size=7)) +
     ggtitle("b) Species Richness")

p2 <- p2 + theme(text = element_text(size=6),
                 plot.title = element_text(size=9),
                 axis.title = element_text(size=8),
                 axis.text = element_text(size=7)) +
     ggtitle("c) Shannon's Diversity")

bi_plot <- bi_plot + ggtitle("a) PCA Biplot") +
           theme(text = element_text(size=6),
                 plot.title = element_text(size=9),
                 axis.title = element_text(size=8),
                 axis.text = element_text(size=7),
                 plot.margin = margin(5, 15, 5, 5)) + # Add right margin to prevent text cutoff
           labs(x = gsub("Dim", "PC", bi_plot$labels$x),
                y = gsub("Dim", "PC", bi_plot$labels$y))

# Arrange plots with custom layout
grid.arrange(bi_plot, p1, p2, layout_matrix = lay)

# Export as PDF with dimensions suitable for scientific publications
# Standard single-column width is typically 3.5 inches, double-column is 7.2 inches
# Using single-column width with appropriate height ratio
#pdf("PCA+cor.pdf", width=4.5, height=3.2) # ~1:0.9 aspect ratio
grid.arrange(bi_plot, p1, p2, layout_matrix = lay)
#dev.off()

# Export as SVG with same dimensions
#svg("PCA+cor.svg", width=4.5, height=3.2)
grid.arrange(bi_plot, p1, p2, layout_matrix = lay)
#dev.off()



```

```{r}
# Create 6 biplots colored by each original variable
p1 <- fviz_pca_biplot(data.pca, 
                      label="var",
                      col.ind=crop_div$crop_rot_SDI,
                      title="Rotation SDI") +
      scale_color_viridis_c(name="crop_rot_SDI")

p2 <- fviz_pca_biplot(data.pca,
                      label="var", 
                      col.ind=crop_div$crop_rot_SEI,
                      title="Rotation SEI") +
      scale_color_viridis_c(name="crop_rot_SEI")

p3 <- fviz_pca_biplot(data.pca,
                      label="var",
                      col.ind=crop_div$crop_rot_rich,
                      title="Rotation Richness") +
      scale_color_viridis_c(name="crop_rot_rich")

p4 <- fviz_pca_biplot(data.pca,
                      label="var",
                      col.ind=crop_div$crop_sp_SDI, 
                      title="Spatial SDI") +
      scale_color_viridis_c(name="crop_sp_SDI")

p5 <- fviz_pca_biplot(data.pca,
                      label="var",
                      col.ind=crop_div$crop_sp_SEI,
                      title="Spatial SEI") +
      scale_color_viridis_c(name="crop_sp_SEI")

p6 <- fviz_pca_biplot(data.pca,
                      label="var",
                      col.ind=crop_div$crop_sp_rich,
                      title="Spatial Richness") +
      scale_color_viridis_c(name="crop_sp_rich")

# Arrange all plots in a grid
grid.arrange(p1, p2, p3, p4, p5, p6, nrow=2, ncol=3)
```


```{r}
# Save grid of plots as PDF
getwd()
#dir.create("D:/Josi/PhD/CrossDIV/WP1.2_Method/WP1.2_Method_Data/R Scripts/4_IACS_Betriebe_exploration/output_files/PCA_results", showWarnings = FALSE)
#setwd("D:/Josi/PhD/CrossDIV/WP1.2_Method/WP1.2_Method_Data/R Scripts/4_IACS_Betriebe_exploration/output_files/PCA_results")
#pdf("crop_diversity_biplots.pdf", width=16, height=12)
grid.arrange(p1, p2, p3, p4, p5, p6, ncol=3)
#dev.off()

#png("crop_diversity_biplots.png", width=1600, height=1200)
grid.arrange(p1, p2, p3, p4, p5, p6, ncol=3)
#dev.off()


```


```{r}
# shows similarities between variables
# --> crop sp variables are all quite similar
# --> crop rot SDI und richness sing ähnlicher als SEi
# the longer the value, the better it is represented
# variable groups are positivles correlated with each other
```

Inspect outliers
```{r}
data_normalized[ 259,]
data_normalized[ 79,]
```


```{r}
fviz_cos2(data.pca, choice = "var", axes = 1:2)

fviz_pca_var(data.pca, col.var = "cos2",
             gradient.cols = c("black", "orange", "green"),
             repel = TRUE)
```



```{r}
# save as csv

data <- as.data.frame(data.pca$scores[, 1:2])

data$cropPC1<- data$Comp.1
data$cropPC2<- data$Comp.2

data <- data[,3:4]
data$id <- crop_div$id

data %>% head()
data %>% summary()

data %>% filter(cropPC1 > 3)
data %>% filter(cropPC1 <= - 5)
# least diverse is id 330 and 449
point_grids[[10]][[330]] # only few crops in space and time
crop_div %>% filter( id == 330)  # low diversity per se? yes, high crop rotation diverse? nee!
crop_div %>% filter( id == 449)  # low diversity
crop_div %>% filter( id == 371)  # high diversity

data %>% filter(cropPC2 > 3) # id 330, 440, 474
crop_div %>% filter( id == 474) 
crop_div %>% filter( id == 330) 
data  %>% filter( id == 330) 
crop_div %>% filter( id == 311) 
data %>% filter(cropPC2 <= - 2.5) # 311 536,
data %>% filter(cropPC2 > 2.5) %>% view() # 311 536, 

crop_div %>% filter( id == 511) 
data  %>% filter( id == 511) 
crop_div %>% summary()
crop_div %>% filter( id == 252) 
```


```{r}
point_grids[[10]][[449]] # only few crops in space and time

for(i in 1:10){
  x <- point_grids[[i]][[449]]$Meaning %>% table()
  print(x)
}


setwd("D:/Josi/PhD/CrossDIV/WP1.2_Method/WP1.2_Method_Data/R Scripts/4_IACS_Betriebe_exploration/output_files")
#write.csv(data, file = "crop_PCA_20241028.csv")

```


# Show distribution in Brandenburg

```{r}
#load library
library(tidyverse)
library(raster)
library(sf)

```

```{r}
setwd("D:/Josi/PhD/CrossDIV/WP1.2_Method/WP1.2_Method_Data/Tips Konlavach/data")
Grid_10x10 = shapefile("Brandenburg_Grid_10x10.shp")
Grid_10x10 %>% head()
```
```{r}
data_gis <- merge(Grid_10x10, data, key = "id")
data_gis %>% head()
```




```{r}
sf_data <- st_as_sf(data_gis)
```


```{r}
# Plot von cropPC1
# Calculate overall min and max across both PCs
overall_min <- min(c(sf_data$cropPC1, sf_data$cropPC2), na.rm = TRUE)
overall_max <- max(c(sf_data$cropPC1, sf_data$cropPC2), na.rm = TRUE)

# Get min/max values for legends
pc1_min <- min(sf_data$cropPC1, na.rm=TRUE)
pc1_max <- max(sf_data$cropPC1, na.rm=TRUE)
pc2_min <- min(sf_data$cropPC2, na.rm=TRUE)
pc2_max <- max(sf_data$cropPC2, na.rm=TRUE)
```


```{r}
PC1 <- ggplot(data = sf_data) +
  geom_sf(aes(fill = cropPC1), color = "white") +
  scale_fill_viridis_c(na.value = "white",
                       name = paste0("cropPC1\n(min: ", round(pc1_min, 2), 
                                   ", max: ", round(pc1_max, 2), ")"),
                       limits = c(pc1_min, pc1_max)) +
  theme_minimal(base_size = 16) +
  ggtitle("Plot of cropPC1") +
  theme(panel.grid = element_blank(),
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        legend.position = "bottom",
        plot.title = element_text(size = 20),
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 14)) +
  coord_sf(expand = FALSE)

PC1
```


```{r}
PC2 <- ggplot(data = sf_data) +
  geom_sf(aes(fill = cropPC2), color = "white") +
  scale_fill_gradient2(low = "red", mid = "#f0f0f0", high = "blue",
                      midpoint = 0,
                      name = paste0("cropPC2\n(min: ", round(pc2_min, 2),
                                  ", max: ", round(pc2_max, 2), ")"),
                      limits = c(pc2_min, pc2_max),
                      na.value = "white") +
  theme_minimal(base_size = 16) +
  ggtitle("Plot of cropPC2") +
  theme(panel.grid = element_blank(),
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        legend.position = "bottom",
        plot.title = element_text(size = 20),
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 14)) +
  coord_sf(expand = FALSE)
PC2
```


```{r}
setwd("D:/Josi/PhD/CrossDIV/WP1.2_Method/WP1.2_Method_Data/R Scripts/4_IACS_Betriebe_exploration/output_files/PCA_results")
# Save as PDF
#pdf("PC_distribution.pdf", width=8.27, height=11.69)
grid.arrange(PC1 + ggtitle("a) PC1"), PC2 + ggtitle("b) PC2"), ncol=2)
#dev.off()
```


```{r}
# Save as SVG
#svg("PC_distribution.svg", width=8.27, height=11.69)
grid.arrange(PC1 + ggtitle("a) PC1"), PC2 + ggtitle("b) PC2"), ncol=2)
#dev.off()


```

To publish this as a shapefile dataset. 

1. Select columns of interest. 
```{r}
sf_data_pub <- sf_data %>% dplyr::select(c(cropPC1, cropPC2, id, geometry)) %>%
  rename(
    space_stime_div = cropPC2,
    overall_crop_div = cropPC1 
  )
```
2. Rename columns. 
```{r}
sf_data_pub
```


3. Save
```{r}
# Choose Working Directory. 
setwd("D:/Josi/PhD/CrossDIV/WP1.2_Method/WP1.2_Method_Data/R Scripts/4_IACS_Betriebe_exploration/output_files/PCA_results")

sf_data_pub %>% 
  st_write(
    dsn        = "Spatiotemporal_crop_diversity.shp",   # output file path
    driver     = "ESRI Shapefile",             # shapefile driver
    delete_dsn = TRUE                          # overwrite if exists
  )
```

