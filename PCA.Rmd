---
title: "PCA of crop diversity in time and space"
author: "Josepha Schiller"
date: "2024-09-27"
output: html_document
---


last update: 19.03.2025

Note: the PCA follows the tutorial from https://www.datacamp.com/tutorial/pca-analysis-r 

Load libraries

```{r, warning=FALSE, message=FALSE}
# load libaries
library(tidyverse)
library(corrr)
library(ggcorrplot)
library(FactoMineR)
library(factoextra)
library(gridExtra)
```

Load spatial and temporal crop information.
```{r}
setwd("D:/Josi/PhD/CrossDIV/WP1.2_Method/WP1.2_Method_Data/R Scripts/4_IACS_Betriebe_exploration/output_files")

# spatial crop diversity (without considering farms)
div_sp <- read.table(file = "farm_grid_spatial_mean_20241028.csv", header = T, sep = ",")
div_sp %>% colnames()

# temporal crop diversity (per field over 10 years)
div_rot <- read.table(file = "crop_rot_div_20241025.csv", header = T, sep = ",")
div_rot %>% colnames()

```

remove unnecessary columns
```{r}
div_sp <- div_sp %>% dplyr::select(Index, crop_sp_SDI,crop_sp_SEI, crop_sp_rich)
div_sp %>% head()
div_rot <- div_rot %>% dplyr::select(!crop_field_nr)
div_rot %>% head()
```

combine both files
```{r}
crop_div <- full_join(div_rot, div_sp, by = c("id" = "Index"))
crop_div %>% head()
```


### Prepare PCA 

1. Normalize
```{r}
numerical_data <- crop_div[,1:7] #select columns of interest, incl. id to identify data points
head(numerical_data)

```


```{r}
data_normalized <- scale(numerical_data[,2:7]) # rescale only crop diversity columns
head(data_normalized)

data_normalized %>% summary()
```


### Apply PCA

```{r}
data.pca <- princomp(data_normalized) # R-mode PCA (feature extraction)
```


```{r}
print(data.pca)
plot(data.pca) # scree plot
biplot(data.pca)
```

Inspect all the information related to the PCA result
```{r}
data.pca$sdev # sdec of principal components
data.pca$loadings # zeigt den einfluss auf ein PC
data.pca$n.obs
data.pca$scale
data.pca$scores %>% head() # this could be used as new variables
data.pca$call
summary(data.pca) # there are 6 components

```


```{r}
my_pca <- data.frame(data.pca$x[, 1:2])

print(data.pca)
plot(data.pca)
```


```{r}
data.pca$loadings[, 1:3]
# --> comp1 crop rot rich + sdi are relatively high, and crop sp, too
# --> crop rot eveness is hgihest, but crop sp are all negativ
# --> copm3 hih crop rot rich,
```


```{r}
#fviz_nbclust(my_pca,
#             FUNcluster = kmeans,
#             method = "wss")
```


```{r}
#set.seed(123)
#my_kmeans <- kmeans(my_pca, centers = 4)

#fviz_pca_ind(data.pca, 
#             habillage = my_kmeans$cluster,
#             label = "none",
 #            addEllipses = T)
```


```{r}
# scree plot
fviz_eig(data.pca, addlabels = TRUE) # shows the percentage of variance explained by components 
# --> can be used to determine how many components will be kept
```


```{r}
fviz_pca_ind(data.pca, col.ind="cos2")

```


```{r}
# Graph of the variables
fviz_pca_var(data.pca, col.var = "black")

```


```{r}
fviz_pca_var(data.pca, col.var="contrib")+
  scale_color_gradient2(low="white", mid="blue",
                        high="red", midpoint = 17) +
  theme_minimal()

bi_plot <- fviz_pca_biplot(data.pca, label ="var", geom = c("point"), alpha.ind = 0.3, pointsize = 1) + 
 theme_minimal() +
  theme(panel.grid = element_blank(),
        panel.grid.major = element_blank(),  # Remove major grid lines
        panel.grid.minor = element_blank(),
        axis.line = element_line(color = "black"),
        panel.border = element_blank())

bi_plot
```


```{r}
setwd("D:/Josi/PhD/CrossDIV/WP1.2_Method/WP1.2_Method_Data/R Scripts/4_IACS_Betriebe_exploration/output_files/PCA_results")

png("PCA_biplots.png", width=420, height=280) # A4 width is ~8.3 inches = 840px at 100dpi, so half is 420px
bi_plot
dev.off()
# A4 width is 8.27 inches, so half width is 4.135 inches
pdf("PCA_biplots.pdf", width=4.135, height=2.76)
bi_plot
dev.off()
```

# create pearson's correlation plots to test temporal and spatial correlation
```{r}
# Calculate correlations
cor_rich <- cor(crop_div$crop_rot_rich, crop_div$crop_sp_rich, method="pearson")
cor_sdi <- cor(crop_div$crop_rot_SDI, crop_div$crop_sp_SDI, method="pearson")
# Create scatter plots
p1 <- ggplot(crop_div, aes(x=crop_rot_rich, y=crop_sp_rich)) +
  geom_point(alpha = 0.3, size = 1) +
  geom_smooth(method = "lm", color = "red", se = F) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(color = "black"),
        panel.border = element_blank()) +
  labs(x = "Over Time\n(Richness)", 
       y = "(Richness)\nIn Space") +
  annotate("text", x = Inf, y = -Inf, 
           label = sprintf("r = %.2f", cor_rich),
           hjust = 1.1, vjust = -0.5)

p2 <- ggplot(crop_div, aes(x = crop_rot_SDI, y = crop_sp_SDI)) +
  geom_point(alpha = 0.3, size = 1) +
  geom_smooth(method = "lm", color = "red", se = F) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(color = "black"),
        panel.border = element_blank()) +
  labs(x = "Over Time\n(SDI)", 
       y = "(SDI)\nIn Space") +
  annotate("text", x = Inf, y = -Inf,
           label = sprintf("r = %.2f", cor_sdi),
           hjust = 1.1, vjust = -0.5)

p1
p2
```


```{r}
# Create layout matrix for arrangement
lay <- rbind(c(1,1),
            c(2,3))


# Adjust text sizes for consistency - using standard sizes for scientific publications
p1 <- p1 + theme(text = element_text(size=6),
                 plot.title = element_text(size=9),
                 axis.title = element_text(size=8),
                 axis.text = element_text(size=7)) +
     ggtitle("b)")

p2 <- p2 + theme(text = element_text(size=6),
                 plot.title = element_text(size=9),
                 axis.title = element_text(size=8),
                 axis.text = element_text(size=7)) +
     ggtitle("c)")

bi_plot <- bi_plot + ggtitle("a)") +
           theme(text = element_text(size=6),
                 plot.title = element_text(size=9),
                 axis.title = element_text(size=8),
                 axis.text = element_text(size=7),
                 plot.margin = margin(5, 15, 5, 5)) + # Add right margin to prevent text cutoff
           labs(x = gsub("Dim", "PC", bi_plot$labels$x),
                y = gsub("Dim", "PC", bi_plot$labels$y))

# Arrange plots with custom layout
grid.arrange(bi_plot, p1, p2, layout_matrix = lay)
```


```{r}
# Export as PDF with dimensions suitable for scientific publications
# Standard single-column width is typically 3.5 inches, double-column is 7.2 inches
# Using single-column width with appropriate height ratio

setwd("D:/Josi/PhD/CrossDIV/WP1.2_Method/WP1.2_Method_Data/R Scripts/4_IACS_Betriebe_exploration/output_files/PCA_results")


pdf("PCA+cor.pdf", width=4.5, height=4.5) # ~1:0.9 aspect ratio
grid.arrange(bi_plot, p1, p2, layout_matrix = lay)
dev.off()

# Export as SVG with same dimensions
svg("PCA+cor.svg", width=4.5, height=4.5)
grid.arrange(bi_plot, p1, p2, layout_matrix = lay)
dev.off()



```
